{"version":3,"sources":["../src/server.js"],"names":["g","require","url","compress","events","XMLHandler","Base","toXMLDate","util","debug","debugDetail","error","Server","constructor","server","path","services","wsdl","options","self","length","load","err","xmlHandler","definitions","schemas","listeners","slice","removeAllListeners","addListener","req","res","authorizeConnection","connection","remoteAddress","end","reqPath","parse","pathname","_requestListener","i","len","call","reqParse","reqQuery","search","log","method","toLowerCase","setHeader","write","toXML","headers","chunks","gunzip","Gunzip","init","on","chunk","inflate","push","xml","join","result","_process","statusCode","stack","input","callback","replace","obj","xmlToJson","body","Body","Header","bindings","binding","operation","operationName","serviceName","portName","includeTimestamp","Security","Timestamp","authenticate","Error","f","firstPort","name","service","ports","port","portPathname","location","style","Object","keys","emit","_executeMethod","outputName","args","messageElemName","pair","topElements","operations","inputParts","message","parts","firstInPart","element","$name","output","outPart","firstOutPart","Fault","undefined","_sendError","handled","_envelope","handleResult","operationDescriptor","describe","outputBodyDescriptor","soapNsURI","soapNsPrefix","envelopeKey","soapVersion","nsContext","createNamespaceContext","envelope","createSOAPEnvelope","jsonToXml","toString","pretty","doc","_addWSSecurityHeader","headerElement","secElement","attribute","now","Date","created","timeStampXml","expires","getTime","tsElement","env","header","soapHeaderElement","addSoapHeadersToEnvelope","fault","faultEnvDescriptor","descriptor","faultEnvelope","elements","bodyDescriptor","faultDescriptor","module","exports"],"mappings":"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","sourcesContent":["// Copyright IBM Corp. 2016,2018. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar g = require('./globalize');\nvar url = require('url'),\n  compress = null,\n  events = require('events'),\n  XMLHandler = require('./parser/xmlHandler'),\n  Base = require('./base'),\n  toXMLDate = require('./utils').toXMLDate,\n  util = require('util'),\n  debug = require('debug')('strong-soap:server'),\n  debugDetail = require('debug')('strong-soap:server:detail');\n\ntry {\n  compress = require('compress');\n} catch (error) {\n  // Ignore error\n}\n\nclass Server extends Base {\n\n  constructor(server, path, services, wsdl, options) {\n    super(wsdl, options);\n    var self = this;\n    options = options || {};\n    this.path = path;\n    this.services = services;\n\n    debug('Server parameters: path: %s services: %j wsdl: %j', path, services, wsdl);\n    if (path[path.length - 1] !== '/')\n      path += '/';\n    wsdl.load(function(err) {\n      if (err) throw err;\n      self.xmlHandler = new XMLHandler(self.wsdl.definitions.schemas, self.wsdl.options);\n      var listeners = server.listeners('request').slice();\n\n      server.removeAllListeners('request');\n      server.addListener('request', function(req, res) {\n        if (typeof self.authorizeConnection === 'function') {\n          if (!self.authorizeConnection(req.connection.remoteAddress)) {\n            res.end();\n            return;\n          }\n        }\n        var reqPath = url.parse(req.url).pathname;\n        if (reqPath[reqPath.length - 1] !== '/')\n          reqPath += '/';\n        if (path === reqPath) {\n          self._requestListener(req, res);\n        } else {\n          for (var i = 0, len = listeners.length; i < len; i++) {\n            listeners[i].call(this, req, res);\n          }\n        }\n      });\n    });\n  }\n\n  _requestListener(req, res) {\n    var self = this;\n    var reqParse = url.parse(req.url);\n    var reqPath = reqParse.pathname;\n    var reqQuery = reqParse.search;\n\n    if (typeof self.log === 'function') {\n      self.log('info', 'Handling ' + req.method + ' on ' + req.url);\n    }\n\n    if (req.method === 'GET') {\n      if (reqQuery && reqQuery.toLowerCase() === '?wsdl') {\n        if (typeof self.log === 'function') {\n          self.log('info', 'Wants the WSDL');\n        }\n        res.setHeader('Content-Type', 'application/xml');\n        res.write(self.wsdl.toXML());\n      }\n      res.end();\n    } else if (req.method === 'POST') {\n      res.setHeader('Content-Type', req.headers['content-type']);\n      var chunks = [], gunzip;\n      if (compress && req.headers['content-encoding'] === 'gzip') {\n        gunzip = new compress.Gunzip();\n        gunzip.init();\n      }\n      req.on('data', function(chunk) {\n        if (gunzip)\n          chunk = gunzip.inflate(chunk, 'binary');\n        chunks.push(chunk);\n      });\n      req.on('end', function() {\n        var xml = chunks.join('');\n        var result;\n        var error;\n        if (gunzip) {\n          gunzip.end();\n          gunzip = null;\n        }\n        try {\n          if (typeof self.log === 'function') {\n            self.log('received', xml);\n          }\n          self._process(xml, req, function(result, statusCode) {\n            if (statusCode) {\n              res.statusCode = statusCode;\n            }\n            res.write(result);\n            res.end();\n            if (typeof self.log === 'function') {\n              self.log('replied', result);\n            }\n          });\n        }\n        catch (err) {\n          error = err.stack || err;\n          res.statusCode = 500;\n          res.write(error);\n          res.end();\n          if (typeof self.log === 'function') {\n            self.log('error', error);\n          }\n        }\n      });\n    }\n    else {\n      res.end();\n    }\n  };\n\n  _process(input, req, callback) {\n    var self = this,\n      pathname = url.parse(req.url).pathname.replace(/\\/$/, ''),\n      obj = this.xmlHandler.xmlToJson(null, input),\n      body = obj.Body,\n      headers = obj.Header,\n      bindings = this.wsdl.definitions.bindings, binding,\n      operation, operationName,\n      serviceName, portName,\n      includeTimestamp = obj.Header && obj.Header.Security &&\n        obj.Header.Security.Timestamp;\n\n    if (typeof self.authenticate === 'function') {\n      if (!obj.Header || !obj.Header.Security) {\n        throw new Error(g.f('No security header'));\n      }\n      if (!self.authenticate(obj.Header.Security)) {\n        throw new Error(g.f('Invalid username or password'));\n      }\n    }\n\n    if (typeof self.log === 'function') {\n      self.log('info', 'Attempting to bind to ' + pathname);\n    }\n\n    // use port.location and current url to find the right binding\n    binding = (function(self) {\n      var services = self.wsdl.definitions.services;\n      var firstPort;\n      var name;\n      for (name in services) {\n        serviceName = name;\n        var service = services[serviceName];\n        var ports = service.ports;\n        for (name in ports) {\n          portName = name;\n          var port = ports[portName];\n          var portPathname = url.parse(port.location).pathname.replace(/\\/$/, '');\n\n          if (typeof self.log === 'function') {\n            self.log('info', 'Trying ' + portName + ' from path ' + portPathname);\n          }\n\n          if (portPathname === pathname)\n            return port.binding;\n\n          // The port path is almost always wrong for generated WSDLs\n          if (!firstPort) {\n            firstPort = port;\n          }\n        }\n      }\n      return !firstPort ? void 0 : firstPort.binding;\n    })(this);\n\n    if (!binding) {\n      throw new Error(g.f('Failed to bind to {{WSDL}}'));\n    }\n\n    try {\n      if (binding.style === 'rpc') {\n        operationName = Object.keys(body)[0];\n\n        self.emit('request', obj, operationName);\n        if (headers)\n          self.emit('headers', headers, operationName);\n\n        self._executeMethod({\n          serviceName: serviceName,\n          portName: portName,\n          operationName: operationName,\n          outputName: operationName + 'Response',\n          args: body[operationName],\n          headers: headers,\n          style: 'rpc'\n        }, req, callback);\n      } else { //document style\n        var messageElemName = (Object.keys(body)[0] === 'attributes' ?\n          Object.keys(body)[1] : Object.keys(body)[0]);\n        var pair = binding.topElements[messageElemName];\n\n        var operationName, outputName;\n        var operations = binding.operations;\n        //figure out the output name\n        for (var name in operations) {\n          var inputParts = operations[name].input.message.parts;\n          //find the first part of the input message. There could be more than one parts in input message.\n          var firstInPart = inputParts[Object.keys(inputParts)[0]];\n          if(firstInPart.element.$name === messageElemName) {\n            operationName = operations[name].$name;\n            if (operations[name].output != null) {\n              var outPart = operations[name].output.message.parts;\n              //there will be only one output part\n              var firstOutPart = outPart[Object.keys(outPart)[0]];\n              outputName = firstOutPart.element.$name;\n            }\n            break;\n          }\n        }\n\n        self.emit('request', obj, operationName);\n        if (headers)\n          self.emit('headers', headers, operationName);\n\n        self._executeMethod({\n          serviceName: serviceName,\n          portName: portName,\n          operationName: operationName,\n          outputName: outputName,\n          args: body[messageElemName],\n          headers: headers,\n          style: 'document',\n          includeTimestamp: includeTimestamp\n        }, req, callback);\n      }\n    } catch (error) {\n      if (error.Fault !== undefined) {\n        return self._sendError(operations[name], error, callback, includeTimestamp);\n      }\n      //Revisit - is this needed?\n      throw error;\n    }\n  };\n\n  _executeMethod(options, req, callback) {\n    options = options || {};\n    var self = this,\n      operation, body,\n      serviceName = options.serviceName,\n      portName = options.portName,\n      operationName = options.operationName,\n      outputName = options.outputName,\n      args = options.args,\n      style = options.style,\n      includeTimestamp = options.includeTimestamp,\n      handled = false;\n\n    try {\n      operation = this.services[serviceName][portName][operationName];\n      debug('Server operation: %s ', operationName);\n    } catch (error) {\n      debug('Server executeMethod: error: %s ', error.message);\n      //fix - should create a fault and call sendError (..) so that this error is not lost and will be sent as Fault in soap envelope\n      //to the client?\n      return callback(this._envelope('', includeTimestamp));\n    }\n\n    function handleResult(error, result) {\n      if (handled)\n        return;\n      handled = true;\n\n      var operation  = self.wsdl.definitions.services[serviceName]\n        .ports[portName].binding.operations[operationName];\n\n\n      if (error && error.Fault !== undefined) {\n        return self._sendError(operation, error, callback, includeTimestamp);\n      }\n      else if (result === undefined) {\n        // Backward compatibility to support one argument callback style\n        result = error;\n      }\n\n      var element = operation.output;\n\n      var operationDescriptor = operation.describe(self.wsdl.definitions);\n      debugDetail('Server handleResult. operationDescriptor: %j ', operationDescriptor);\n\n      var outputBodyDescriptor = operationDescriptor.output.body;\n      debugDetail('Server handleResult. outputBodyDescriptor: %j ', outputBodyDescriptor);\n\n      var soapNsURI = 'http://schemas.xmlsoap.org/soap/envelope/';\n      var soapNsPrefix = self.wsdl.options.envelopeKey || 'soap';\n\n      if (operation.soapVersion === '1.2') {\n        soapNsURI = 'http://www.w3.org/2003/05/soap-envelope';\n      }\n\n      debug('Server soapNsURI: %s soapNsPrefix: %s', soapNsURI, soapNsPrefix);\n\n      var nsContext = self.createNamespaceContext(soapNsPrefix, soapNsURI);\n      var envelope = XMLHandler.createSOAPEnvelope(soapNsPrefix, soapNsURI);\n\n\n      self.xmlHandler.jsonToXml(envelope.body, nsContext, outputBodyDescriptor, result);\n\n      self._envelope(envelope, includeTimestamp);\n      var message = envelope.body.toString({pretty: true});\n      var xml = envelope.doc.end({pretty: true});\n\n      debug('Server handleResult. xml: %s ', xml);\n      callback(xml);\n\n    }\n\n    if (!self.wsdl.definitions.services[serviceName].ports[portName]\n        .binding.operations[operationName].output) {\n      // no output defined = one-way operation so return empty response\n      handled = true;\n      callback('');\n    }\n\n    var result = operation(args, handleResult, options.headers, req);\n    if (typeof result !== 'undefined') {\n      handleResult(null, result);\n    }\n  };\n\n  _addWSSecurityHeader(headerElement) {\n    var secElement = headerElement.element('wsse:Security')\n      .attribute('soap:mustUnderstand', '1');\n\n    secElement\n      .attribute('xmlns:wsse', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-secext-1.0.xsd')\n      .attribute('xmlns:wsu', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-utility-1.0.xsd');\n\n    var now = new Date();\n    var created = toXMLDate(now);\n    var timeStampXml = '';\n\n    var expires = toXMLDate(new Date(now.getTime() + (1000 * 600)));\n\n    var tsElement = secElement.element('wsu:Timestamp')\n      .attribute('wsu:Id', 'Timestamp-' + created);\n    tsElement.element('wsu:Created', created);\n    tsElement.element('wsu:Expires', expires);\n\n  }\n\n  _envelope(env, includeTimestamp) {\n    env = env || XMLHandler.createSOAPEnvelope();\n\n    if (includeTimestamp) {\n      this._addWSSecurityHeader(env.header);\n    }\n\n    var soapHeaderElement = env.header;\n    //add soapHeaders to envelope. Header can be xml, or JSON object which may or may not be described in WSDL/XSD.\n    this.addSoapHeadersToEnvelope(soapHeaderElement, this.xmlHandler);\n    return env;\n  };\n\n  _sendError(operation, error, callback, includeTimestamp) {\n    var self = this,\n      fault;\n\n    var statusCode;\n    if (error.Fault.statusCode) {\n      statusCode = error.Fault.statusCode;\n      error.Fault.statusCode = undefined;\n    }\n\n    var operationDescriptor = operation.describe(this.wsdl.definitions);\n    debugDetail('Server sendError. operationDescriptor: %j ', operationDescriptor);\n\n    //get envelope descriptor\n    var faultEnvDescriptor = operation.descriptor.faultEnvelope.elements[0];\n\n\n    var soapNsURI = 'http://schemas.xmlsoap.org/soap/envelope/';\n    var soapNsPrefix = self.wsdl.options.envelopeKey || 'soap';\n\n    if (operation.soapVersion === '1.2') {\n      soapNsURI = 'http://www.w3.org/2003/05/soap-envelope';\n    }\n\n    var nsContext = self.createNamespaceContext(soapNsPrefix, soapNsURI);\n    var envelope = XMLHandler.createSOAPEnvelope(soapNsPrefix, soapNsURI);\n\n\n    //find the envelope body descriptor\n    var bodyDescriptor = faultEnvDescriptor.elements[1];\n\n    //there will be only one <Fault> element descriptor under <Body>\n    var faultDescriptor = bodyDescriptor.elements[0];\n    debugDetail('Server sendError. faultDescriptor: %j ', faultDescriptor);\n\n    debug('Server sendError.  error.Fault: %j ',  error.Fault);\n\n    //serialize Fault object into XML as per faultDescriptor\n    this.xmlHandler.jsonToXml(envelope.body, nsContext, faultDescriptor, error.Fault);\n\n    self._envelope(envelope, includeTimestamp);\n    var message = envelope.body.toString({pretty: true});\n    var xml = envelope.doc.end({pretty: true});\n\n    debug('Server sendError. Response envelope: %s ', xml);\n    callback(xml, statusCode);\n  }\n}\n\nmodule.exports = Server;\n"],"file":"server.js"}