{"version":3,"sources":["../../src/parser/element.js"],"names":["g","require","assert","QName","typeRegistry","helper","xsd","debug","EMPTY_PREFIX","namespaces","Element","constructor","nsName","attrs","options","qname","parse","prefix","name","nsURI","parent","children","xmlns","elementName","_initializeOptions","key","match","exec","xsd_rc","xsi_rc","xsi","valueKey","$targetNamespace","targetNamespace","xmlKey","ignoredNamespaces","forceSoapVersion","startElement","stack","allowedChildren","child","length","_qnameFor","ElementType","getElementType","indexOf","getTargetNamespace","push","unexpected","endElement","extend","addChild","pop","getNamespaceURI","Error","f","describe","definitions","$name","xml","getQName","resolveSchemaObject","schemas","elementType","getBuiltinType","schema","found","elements","complexTypes","simpleTypes","groups","attributes","attributeGroups","postProcess","module","exports"],"mappings":"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","sourcesContent":["// Copyright IBM Corp. 2016,2017. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar g = require('../globalize');\nvar assert = require('assert');\nvar QName = require('./qname');\nvar typeRegistry = require('./typeRegistry');\nvar helper = require('./helper');\nvar xsd = require('./xsd');\nvar debug = require('debug')('strong-soap:wsdl:element');\n\nvar EMPTY_PREFIX = helper.EMPTY_PREFIX;\nvar namespaces = helper.namespaces;\n\n/**\n * Base class for all elements of WSDL/XSD\n */\nclass Element {\n  constructor(nsName, attrs, options) {\n    var qname = QName.parse(nsName);\n\n    this.nsName = nsName;\n    this.prefix = qname.prefix;\n    this.name = qname.name;\n    this.nsURI = '';\n    this.parent = null;\n    this.children = [];\n    this.xmlns = {};\n\n    if (this.constructor.elementName) {\n      assert(this.name === this.constructor.elementName,\n        'Invalid element name: ' + this.name);\n    }\n\n    this._initializeOptions(options);\n\n    for (var key in attrs) {\n      var match = /^xmlns:?(.*)$/.exec(key);\n      if (match) {\n        if (attrs[key] === namespaces.xsd_rc) {\n          // Handle http://www.w3.org/2000/10/XMLSchema\n          attrs[key] = namespaces.xsd;\n        }\n        if (attrs[key] === namespaces.xsi_rc) {\n          // Handle http://www.w3.org/2000/10/XMLSchema-instance\n          attrs[key] = namespaces.xsi;\n        }\n        this.xmlns[match[1] ? match[1] : EMPTY_PREFIX] = attrs[key];\n      }\n      else {\n        if (key === 'value') {\n          this[this.valueKey] = attrs[key];\n        } else {\n          this['$' + key] = attrs[key];\n        }\n      }\n    }\n    if (this.$targetNamespace) {\n      this.targetNamespace = this.$targetNamespace;\n    }\n  }\n\n  _initializeOptions(options) {\n    if (options) {\n      this.valueKey = options.valueKey || '$value';\n      this.xmlKey = options.xmlKey || '$xml';\n      this.ignoredNamespaces = options.ignoredNamespaces || [];\n      this.forceSoapVersion = options.forceSoapVersion;\n    } else {\n      this.valueKey = '$value';\n      this.xmlKey = '$xml';\n      this.ignoredNamespaces = [];\n    }\n  }\n\n  startElement(stack, nsName, attrs, options) {\n    if (!this.constructor.allowedChildren)\n      return;\n\n    var child;\n    var parent = stack[stack.length - 1];\n\n    var qname = this._qnameFor(stack, nsName, attrs, options);\n    var ElementType = typeRegistry.getElementType(qname);\n    if (this.constructor.allowedChildren.indexOf(qname.name) === -1 &&\n      this.constructor.allowedChildren.indexOf('any') === -1) {\n      debug('Element %s is not allowed within %j', qname, this.nsName);\n    }\n    \n    if (ElementType) {\n      child = new ElementType(nsName, attrs, options);\n      child.nsURI = qname.nsURI;\n      child.targetNamespace = attrs.targetNamespace || this.getTargetNamespace();\n      debug('Element created: ', child);\n      child.parent = parent;\n      stack.push(child);\n    } else {\n      this.unexpected(nsName);\n    }\n  }\n\n  endElement(stack, nsName) {\n    if (this.nsName === nsName) {\n      if (stack.length < 2)\n        return;\n      var parent = stack[stack.length - 2];\n      if (this !== stack[0]) {\n        helper.extend(stack[0].xmlns, this.xmlns);\n        parent.children.push(this);\n        parent.addChild(this);\n      }\n      stack.pop();\n    }\n  }\n\n  _qnameFor(stack, nsName, attrs, options) {\n    // Create a dummy element to help resolve the XML namespace\n    var child = new Element(nsName, attrs, options);\n    var parent = stack[stack.length - 1];\n    child.parent = parent;\n\n    var qname = QName.parse(nsName);\n    qname.nsURI = child.getNamespaceURI(qname.prefix);\n    return qname;\n  }\n\n  addChild(child) {\n    return;\n  }\n\n  unexpected(name) {\n    throw new Error(g.f('Found unexpected element (%s) inside %s', name, this.nsName));\n  }\n\n  describe(definitions) {\n    return this.$name || this.name;\n  }\n\n  /**\n   * Look up the namespace by prefix\n   * @param {string} prefix Namespace prefix\n   * @returns {string} Namespace\n   */\n  getNamespaceURI(prefix) {\n    if (prefix === 'xml') return helper.namespaces.xml;\n    var nsURI = null;\n    if (this.xmlns && prefix in this.xmlns) {\n      nsURI = this.xmlns[prefix];\n    } else {\n      if (this.parent) {\n        return this.parent.getNamespaceURI(prefix);\n      }\n    }\n    return nsURI;\n  }\n\n  /**\n   * Get the target namespace URI\n   * @returns {string} Target namespace URI\n   */\n  getTargetNamespace() {\n    if (this.targetNamespace) {\n      return this.targetNamespace;\n    } else if (this.parent) {\n      return this.parent.getTargetNamespace();\n    }\n    return null;\n  }\n\n  /**\n   * Get the qualified name\n   * @returns {QName} Qualified name\n   */\n  getQName() {\n    return new QName(this.targetNamespace, this.$name);\n  }\n\n  /**\n   * Resolve a schema object by qname\n   * @param schemas\n   * @param elementType\n   * @param nsName\n   * @returns {*}\n   */\n  resolveSchemaObject(schemas, elementType, nsName) {\n    var qname = QName.parse(nsName);\n    var nsURI;\n    if (qname.prefix === 'xml') return null;\n    if (qname.prefix) nsURI = this.getNamespaceURI(qname.prefix);\n    else nsURI = this.getTargetNamespace();\n    qname.nsURI = nsURI;\n    var name = qname.name;\n    if (nsURI === helper.namespaces.xsd &&\n      (elementType === 'simpleType' || elementType === 'type')) {\n      return xsd.getBuiltinType(name);\n    }\n    var schema = schemas[nsURI];\n    if (!schema) {\n      debug('Schema not found: %s (%s)', qname, elementType);\n      return null;\n    }\n    var found = null;\n    switch (elementType) {\n      case 'element':\n        found = schema.elements[name];\n        break;\n      case 'type':\n        found = schema.complexTypes[name] || schema.simpleTypes[name];\n        break;\n      case 'simpleType':\n        found = schema.simpleTypes[name];\n        break;\n      case 'complexType':\n        found = schema.complexTypes[name];\n        break;\n      case 'group':\n        found = schema.groups[name];\n        break;\n      case 'attribute':\n        found = schema.attributes[name];\n        break;\n      case 'attributeGroup':\n        found = schema.attributeGroups[name];\n        break;\n    }\n    if (!found) {\n      debug('Schema %s not found: %s %s', elementType, nsURI, nsName);\n      return null;\n    }\n    return found;\n  }\n\n  postProcess(definitions) {\n    debug('Unknown element: %s %s', this.nsURI, this.nsName)\n  }\n}\n\nElement.EMPTY_PREFIX = EMPTY_PREFIX;\nElement.namespaces = namespaces;\n\nmodule.exports = Element;\n"],"file":"element.js"}